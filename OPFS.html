<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IDE v9.6: Fixed Scroll & Run</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: #f0f4f9; --text: #1f1f1f; --sidebar: #ffffff; --border: #dfe3e7;
            --header: #ffffff; --header-text: #1f1f1f;
            --line-bg: #e1e5ea; --line-text: #747775;
            --accent: #0b57d0; --success: #146c2e; --warn: #ea8600; --danger: #b3261e;
            /* Syntax */
            --tag: #0b57d0; --attr: #b3261e; --str: #146c2e; --key: #8ab4f8; --comm: #747775;
        }
        body.midnight {
            --bg: #000; --text: #0f0; --sidebar: #111; --border: #333;
            --header: #000; --header-text: #0f0; --line-bg: #111; --line-text: #0f0;
            --accent: #0f0; --tag: #0f0; --attr: #0a0; --str: #0f0; --key: #0f0;
        }

        /* --- LAYOUT --- */
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        header { 
            height: 45px; background: var(--header); border-bottom: 1px solid var(--border); display: flex; 
            align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; color: var(--header-text);
        }

        .controls { 
            padding: 8px 15px; background: var(--sidebar); border-bottom: 1px solid var(--border); 
            display: flex; gap: 8px; align-items: center; flex-shrink: 0; flex-wrap: wrap; 
        }

        .main-layout { display: flex; flex: 1; overflow: hidden; }

        .sidebar { width: 320px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .tab-row { display: flex; background: rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 10px; font-weight: bold; cursor: pointer; opacity: 0.7; }
        .tab.active { background: var(--sidebar); color: var(--accent); border-bottom: 2px solid var(--accent); opacity: 1; }
        .pane { display: none; flex: 1; flex-direction: column; padding: 10px; overflow-y: auto; }
        .pane.active { display: flex; }

        /* --- EDITOR ENGINE (FIXED SCROLL) --- */
        .workspace { flex: 1; display: grid; grid-template-rows: 1fr auto; min-width: 0; background: var(--bg); }
        
        .editor-container { 
            position: relative; display: flex; overflow: hidden; /* Hide outer scroll */
        }

        #line-numbers { 
            width: 45px; background: var(--line-bg); color: var(--line-text); 
            text-align: right; padding: 10px 5px; font-family: 'Fira Code', monospace; 
            font-size: 13px; line-height: 1.5; border-right: 1px solid var(--border);
            user-select: none; overflow: hidden;
        }

        .editor-stack { 
            flex: 1; position: relative; min-width: 0; /* Allow grid shrink */
        }

        /* The Input Layer (Scroll Master) */
        #editor {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 10px; border: 0;
            font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5;
            white-space: pre; /* Force horizontal scroll */
            color: transparent; background: transparent; caret-color: var(--text);
            z-index: 2; overflow: scroll; /* ALWAYS SHOW SCROLLBARS */
            resize: none; outline: none; box-sizing: border-box;
        }

        /* The Visual Layer (Follower) */
        #highlighting {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 10px; border: 0;
            font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5;
            white-space: pre; /* Match editor wrapping */
            color: var(--text); z-index: 1; pointer-events: none; overflow: hidden;
            box-sizing: border-box;
        }

        /* --- CONSOLE & UI --- */
        #console-container { height: 140px; background: #1e1e1e; color: #ccc; display: flex; flex-direction: column; transition: 0.2s; }
        #console-container.minimized { height: 30px; }
        .c-toolbar { padding: 5px 10px; background: #252526; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
        #console { flex: 1; padding: 10px; font-family: monospace; font-size: 11px; overflow: auto; }

        button { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); cursor: pointer; font-size: 11px; font-weight: bold; background: #fff; color: #333; }
        .btn-p { background: var(--accent); color: #fff; border: none; }
        .btn-d { background: var(--danger); color: #fff; border: none; }
        .db-entry { padding: 8px; border: 1px solid var(--border); border-left: 3px solid var(--danger); margin-bottom: 5px; background: rgba(255,255,255,0.5); font-size: 11px; }
        
        /* Syntax Colors */
        .t-tag { color: var(--tag); } .t-attr { color: var(--attr); } .t-str { color: var(--str); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="gemini">

<header>
    <div>IDE v9.6</div>
    <div id="status" style="font-size: 11px; opacity: 0.7;">Disconnected</div>
</header>

<div class="controls">
    <button class="btn-p" id="mountBtn">Initialize System</button>
    <button class="btn-d" id="wipeBtn" disabled>Wipe</button>
    <div style="width:1px; height:16px; background:#ccc; margin:0 5px;"></div>
    <button id="runBtn" class="btn-p" disabled>‚ñ∂ Run in Window</button>
    <button id="auditBtn" disabled>üõ°Ô∏è Audit</button>
    <button id="saveBtn" disabled>Save</button>
    <button id="newFileBtn" disabled>+ File</button>
    <button id="demoBtn" disabled>Load Demo</button>
    <button onclick="document.body.className='gemini'">Light</button>
    <button onclick="document.body.className='midnight'">Dark</button>
</div>

<div class="main-layout">
    <div class="sidebar">
        <div class="tab-row">
            <div class="tab active" onclick="tab('files')">FILES</div>
            <div class="tab" onclick="tab('db')">DB</div>
            <div class="tab" onclick="tab('tools')">TOOLS</div>
        </div>
        <div id="filesPane" class="pane active">
            <div id="tree-root"></div>
        </div>
        <div id="dbPane" class="pane">
            <button class="btn-p" style="width:100%; margin-bottom:10px;" id="addEntryBtn">Add Log</button>
            <div id="dbList"></div>
        </div>
        <div id="toolsPane" class="pane">
            <input type="text" id="gFind" placeholder="Search files..." style="width:100%; padding:5px; margin-bottom:5px;">
            <button class="btn-p" style="width:100%" id="searchBtn">Deep Search</button>
            <div id="searchResults" style="margin-top:10px; font-size:11px;"></div>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-container">
            <div id="line-numbers">1</div>
            <div class="editor-stack">
                <pre id="highlighting"><code id="h-content"></code></pre>
                <textarea id="editor" spellcheck="false" wrap="off" placeholder="Initialize to start..."></textarea>
            </div>
        </div>
        <div id="console-container">
            <div class="c-toolbar" onclick="toggleConsole()">
                <span>CONSOLE OUTPUT</span>
                <span>‚ñº</span>
            </div>
            <div id="console"></div>
        </div>
    </div>
</div>

<script>
    let rootHandle, currentHandle;
    const editor = document.getElementById('editor');
    const high = document.getElementById('highlighting');
    const hContent = document.getElementById('h-content');
    const lNums = document.getElementById('line-numbers');
    const con = document.getElementById('console');

    // --- SCROLL SYNC FIX ---
    editor.onscroll = () => {
        high.scrollTop = editor.scrollTop;
        high.scrollLeft = editor.scrollLeft;
        lNums.scrollTop = editor.scrollTop;
    };

    // --- SYNTAX HIGHLIGHTING ---
    const updateHigh = (text) => {
        let code = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        code = code.replace(/(&lt;\/?[a-z0-9]+)/gi, '<span class="t-tag">$1</span>');
        code = code.replace(/(\s)([a-z-]+)(?==)/gi, '$1<span class="t-attr">$2</span>');
        code = code.replace(/"(.*?)"/g, '<span class="t-str">"$1"</span>');
        hContent.innerHTML = code + "\n"; 
        lNums.innerHTML = Array.from({length: text.split('\n').length}, (_, i) => i + 1).join('<br>');
    };
    editor.oninput = () => updateHigh(editor.value);

    // --- LOGGING ---
    const log = (m, type='info') => {
        const d = document.createElement('div');
        d.textContent = `> ${m}`;
        if(type==='err') d.style.color = '#ff6b6b';
        if(type==='ok') d.style.color = '#51cf66';
        con.appendChild(d); con.scrollTop = con.scrollHeight;
    };

    // --- OPFS INIT ---
    document.getElementById('mountBtn').onclick = async () => {
        try {
            rootHandle = await navigator.storage.getDirectory();
            try { await rootHandle.getFileHandle('vuln_db.json'); }
            catch { 
                const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true});
                const w = await fh.createWritable(); await w.write("[]"); await w.close();
            }
            await buildTree();
            enableControls();
            loadDB();
            log("System Mounted.", "ok");
        } catch(e) { log(e.message, 'err'); }
    };

    function enableControls() {
        document.querySelectorAll('button').forEach(b => b.disabled = false);
    }

    // --- FILE TREE ---
    async function buildTree() {
        const root = document.getElementById('tree-root');
        root.innerHTML = "";
        for await (const e of rootHandle.values()) {
            const div = document.createElement('div');
            div.style.padding = "4px 8px";
            div.style.cursor = "pointer";
            div.innerHTML = e.kind === 'directory' ? `üìÅ ${e.name}` : `üìÑ ${e.name}`;
            div.onclick = () => { if(e.kind==='file') loadFile(e); };
            root.appendChild(div);
        }
    }

    async function loadFile(h) {
        currentHandle = h;
        const text = await (await h.getFile()).text();
        editor.value = text;
        updateHigh(text);
        document.getElementById('status').textContent = `Editing: ${h.name}`;
    }

    // --- RUN IN WINDOW ---
    document.getElementById('runBtn').onclick = () => {
        const win = window.open("", "_blank");
        win.document.write(editor.value);
        win.document.close();
        log("Opened in new window.", "ok");
    };

    // --- AUDIT & DB ---
    document.getElementById('auditBtn').onclick = async () => {
        log("Scanning...", "warn");
        const findings = [];
        for await (const e of rootHandle.values()) {
            if(e.kind === 'file' && e.name.endsWith('.html')) {
                const t = await (await e.getFile()).text();
                if(t.includes('innerHTML')) findings.push({t:"XSS Risk", d:`In: ${e.name}`});
                if(t.includes('http:')) findings.push({t:"Insecure HTTP", d:`In: ${e.name}`});
            }
        }
        
        if(findings.length > 0) {
            log(`Found ${findings.length} issues.`, "err");
            const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true});
            const old = await (await fh.getFile()).text();
            const db = old ? JSON.parse(old) : [];
            const newDB = [...db, ...findings];
            const w = await fh.createWritable();
            await w.write(JSON.stringify(newDB));
            await w.close();
            loadDB();
        } else { log("Clean scan.", "ok"); }
    };

    async function loadDB() {
        try {
            const fh = await rootHandle.getFileHandle('vuln_db.json');
            const txt = await (await fh.getFile()).text();
            const list = document.getElementById('dbList');
            list.innerHTML = "";
            JSON.parse(txt).forEach(x => {
                list.innerHTML += `<div class="db-entry"><b>${x.t}</b><br>${x.d}</div>`;
            });
        } catch(e){}
    }

    document.getElementById('demoBtn').onclick = async () => {
        const name = "vuln_demo.html";
        const content = `<html><body><script>document.body.innerHTML="<h1>XSS</h1>"; fetch('http://bad.com');<\/script></body></html>`;
        const fh = await rootHandle.getFileHandle(name, {create:true});
        const w = await fh.createWritable(); await w.write(content); await w.close();
        buildTree();
        log("Demo created.", "ok");
    };

    document.getElementById('saveBtn').onclick = async () => {
        if(currentHandle) {
            const w = await currentHandle.createWritable();
            await w.write(editor.value); await w.close();
            log("Saved.", "ok");
        }
    };

    document.getElementById('newFileBtn').onclick = async () => {
        const n = prompt("Name:"); if(n) { await rootHandle.getFileHandle(n, {create:true}); buildTree(); }
    };

    function tab(id) {
        document.querySelectorAll('.tab, .pane').forEach(e => e.classList.remove('active'));
        document.querySelector(`.tab[onclick="tab('${id}')"]`).classList.add('active');
        document.getElementById(id+'Pane').classList.add('active');
    }
    
    function toggleConsole() { document.getElementById('console-container').classList.toggle('minimized'); }
</script>
</body>
</html>
