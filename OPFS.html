<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IDE v9.3: Verified Audit & DB</title>
    <style>
        :root {
            --primary: #1877f2; --border: #ddd; --header-bg: #1877f2; --header-text: #fff;
            --sidebar-bg: #fff; --sidebar-text: #333; --editor-bg: #282c34; --editor-text: #abb2bf;
            --line-num-bg: #21252b; --line-num-text: #636d83; --success: #42b72a; --danger: #f48771; --warn: #eab308;
        }
        body.midnight { --editor-bg: #000; --sidebar-bg: #111; --sidebar-text: #0f0; --border: #333; --header-bg: #000; --header-text: #0f0; --line-num-bg: #000; --line-num-text: #0f0; }
        body.light { --editor-bg: #fff; --editor-text: #222; --sidebar-bg: #f8f9fa; --border: #ccc; --line-num-bg: #f0f0f0; --line-num-text: #999; }

        body { font-family: system-ui, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--header-bg); color: var(--header-text); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 45px; flex-shrink: 0; }
        
        .controls { padding: 8px 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; flex-shrink: 0; flex-wrap: wrap; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar { width: 350px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .tab-row { display: flex; background: rgba(0,0,0,0.05); border-bottom: 1px solid var(--border); }
        .tab { flex: 1; padding: 10px 5px; text-align: center; cursor: pointer; font-size: 9px; font-weight: bold; color: #666; transition: 0.2s; }
        .tab.active { background: var(--sidebar-bg); color: var(--primary); border-bottom: 2px solid var(--primary); }
        .pane { display: none; flex: 1; flex-direction: column; padding: 12px; overflow-y: auto; }
        .pane.active { display: flex; }

        /* Tree UI */
        .tree-root-node { font-weight: bold; color: var(--primary); margin-bottom: 5px; font-size: 11px; padding: 0 8px; }
        .tree-item { margin-left: 18px; border-left: 1px solid rgba(0,0,0,0.1); }
        .tree-row { display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 13px; user-select: none; border: 1px solid transparent; }
        .tree-row:hover { background: rgba(0,0,0,0.05); }
        .tree-row.active { background: #e7f3ff; color: var(--primary); font-weight: 600; }
        .drag-over { background: rgba(24, 119, 242, 0.1); border: 1px dashed var(--primary); }
        .folder-icon { margin-right: 6px; font-size: 10px; width: 12px; display: inline-block; transition: transform 0.1s; }

        /* DB Entry Styles */
        .db-entry { background: #fff; border: 1px solid #ccc; border-left: 3px solid var(--danger); border-radius: 4px; padding: 8px; margin-bottom: 8px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .db-title { font-weight: bold; font-size: 12px; color: #333; margin-bottom: 4px; }
        .db-desc { font-size: 11px; color: #666; margin-bottom: 4px; line-height: 1.4; }
        .db-meta { font-size: 9px; color: #999; text-align: right; }
        
        .net-item { font-size: 11px; padding: 6px; border-bottom: 1px solid #eee; font-family: monospace; }

        /* Workspace */
        .workspace { flex: 1; display: grid; grid-template-rows: 1fr auto; background: #ccc; overflow: hidden; }
        .panes { display: grid; grid-template-columns: 1fr; gap: 1px; height: 100%; min-height: 0; }
        .editor-container { position: relative; background: var(--editor-bg); display: flex; overflow: hidden; }
        #line-numbers { width: 40px; background: var(--line-num-bg); color: var(--line-num-text); padding: 15px 5px; text-align: right; font-family: monospace; font-size: 13px; line-height: 1.6; user-select: none; }
        .editor-stack { flex: 1; position: relative; overflow: hidden; }
        #editor, #highlighting { margin: 0; padding: 15px; border: 0; width: 100%; height: 100%; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.6; white-space: pre; position: absolute; top: 0; left: 0; box-sizing: border-box; overflow: auto; outline: none; }
        #editor { color: transparent; background: transparent; caret-color: #fff; z-index: 2; resize: none; }
        #highlighting { color: var(--editor-text); z-index: 1; pointer-events: none; }
        
        #console-container { display: flex; flex-direction: column; background: #1e1e1e; border-top: 2px solid #333; height: 140px; transition: height 0.2s; flex-shrink: 0; }
        #console-container.minimized { height: 30px; }
        .c-toolbar { background: #252526; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; color: #888; font-size: 10px; font-weight: bold; cursor: pointer; }
        #console { flex: 1; color: #d4d4d4; padding: 10px; font-family: monospace; font-size: 11px; overflow-y: auto; }
        
        button { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; font-size: 11px; background: #e4e6eb; margin-top:4px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-run { background: var(--success); color: white; }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-demo { background: #9c27b0; color: white; }
        .btn-red { background: var(--danger); color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<header>
    <div>Local IDE v9.3 (OPFS)</div>
    <div id="file-label" style="font-size: 11px; opacity: 0.7;">System Ready</div>
</header>

<div class="controls">
    <button class="btn-blue" id="mountBtn">Initialize</button>
    <button class="btn-red" id="wipeBtn" disabled>Wipe</button>
    <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
    <button class="btn-demo" id="demoBtn" disabled>‚ö° Load Demo</button>
    <button class="btn-run" id="runBtn" disabled>‚ñ∂ Run in Window</button>
    <button class="btn-warn" id="auditBtn" disabled>üõ°Ô∏è Audit & Log</button>
    <button id="saveBtn" disabled>Save</button>
    <button id="newFileBtn" disabled>+ File</button>
    <button id="newFolderBtn" disabled>+ Folder</button>
    <button id="backupBtn" disabled>üíæ ZIP</button>
</div>

<div class="main-layout">
    <div class="sidebar">
        <div class="tab-row">
            <div class="tab active" onclick="switchTab('explorer')">FILES</div>
            <div class="tab" onclick="switchTab('db')">DB</div>
            <div class="tab" onclick="switchTab('network')">NET</div>
            <div class="tab" onclick="switchTab('tools')">TOOLS</div>
        </div>
        
        <div id="explorerPane" class="pane active">
            <div id="tree-root-header" class="tree-root-node"></div>
            <div id="tree-root"></div>
        </div>

        <div id="dbPane" class="pane">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <b style="font-size:11px;">VULNERABILITY DATABASE</b>
                <span onclick="loadDB()" style="cursor:pointer; color:var(--primary); font-size:10px;">REFRESH</span>
            </div>
            <div id="dbList" style="font-size:11px;">(No entries yet)</div>
        </div>

        <div id="networkPane" class="pane">
            <div style="font-size: 10px; color: #888; margin-bottom: 10px;">TRAFFIC MONITOR</div>
            <div id="netList"></div>
        </div>

        <div id="toolsPane" class="pane">
            <button onclick="setTheme('')" style="width:100%; margin-bottom:5px;">One Dark</button>
            <button onclick="setTheme('midnight')" style="width:100%; background:#000; color:#0f0;">Midnight</button>
        </div>
    </div>

    <div class="workspace">
        <div class="panes">
            <div class="editor-container">
                <div id="line-numbers">1</div>
                <div class="editor-stack">
                    <pre id="highlighting"><code id="h-content"></code></pre>
                    <textarea id="editor" spellcheck="false" placeholder="Initialize OPFS to start..."></textarea>
                </div>
            </div>
        </div>
        <div id="console-container">
            <div class="c-toolbar" onclick="toggleConsole()">
                <span>CONSOLE & AUDIT LOGS</span>
                <span>
                    <span id="mitigateBtn" style="color:var(--warn); margin-right:10px; display:none;" onclick="event.stopPropagation(); applyMitigation()">[ FIX VULN ]</span>
                    <span id="toggleIcon">‚ñº</span>
                </span>
            </div>
            <div id="console">> IDE Ready. v9.3</div>
        </div>
    </div>
</div>

<script>
    let rootHandle, currentFileHandle;
    let runWindow = null;
    let draggedItem = null;
    
    const editor = document.getElementById('editor');
    const hContent = document.getElementById('h-content');
    const consoleEl = document.getElementById('console');
    const lineNumbers = document.getElementById('line-numbers');

    function log(msg, color = null) {
        const d = document.createElement('div');
        if(color) d.style.color = color;
        d.textContent = `> ${msg}`;
        consoleEl.appendChild(d); consoleEl.scrollTop = consoleEl.scrollHeight;
    }
    function switchTab(t) {
        document.querySelectorAll('.tab, .pane').forEach(el => el.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById(`${t}Pane`).classList.add('active');
    }
    function setTheme(t) { document.body.className = t; }
    function toggleConsole() {
        const c = document.getElementById('console-container');
        c.classList.toggle('minimized');
    }

    // --- INIT & OPFS ---
    document.getElementById('mountBtn').onclick = async () => {
        try {
            rootHandle = await navigator.storage.getDirectory();
            document.getElementById('tree-root-header').textContent = `üìÅ OPFS://ROOT`;
            
            // Allow Drop on Root
            const rootHeader = document.getElementById('tree-root-header');
            rootHeader.ondragover = e => { e.preventDefault(); rootHeader.style.background = '#e7f3ff'; };
            rootHeader.ondragleave = () => rootHeader.style.background = 'transparent';
            rootHeader.ondrop = async e => {
                e.preventDefault(); rootHeader.style.background = 'transparent';
                if(!draggedItem || draggedItem.parent === rootHandle) return;
                try { await moveEntry(draggedItem.name, draggedItem.parent, rootHandle, draggedItem.kind); await buildTree(rootHandle, document.getElementById('tree-root')); }
                catch(err){ log("Move failed.", "var(--danger)"); }
            };

            await buildTree(rootHandle, document.getElementById('tree-root'));
            enableControls();
            
            // Auto-Initialize DB File if missing
            try {
                await rootHandle.getFileHandle('vulnerabilities.json');
            } catch {
                const fh = await rootHandle.getFileHandle('vulnerabilities.json', {create:true});
                const w = await fh.createWritable(); await w.write("[]"); await w.close();
                log("Initialized empty DB file.", "var(--primary)");
            }
            
            loadDB();
            log("OPFS Mounted.", "var(--success)");
        } catch(e) { log("OPFS Error: " + e.message, "var(--danger)"); }
    };

    function enableControls() {
        ['newFileBtn','newFolderBtn','backupBtn','wipeBtn','saveBtn','runBtn','demoBtn','auditBtn'].forEach(i=>document.getElementById(i).disabled=false);
    }

    // --- DEMO CREATION ---
    document.getElementById('demoBtn').onclick = async () => {
        const name = "vulnerable_demo.html";
        const content = `<!DOCTYPE html><html><body><h1>XSS Test</h1><div id="out"></div><script>
        const url="http://unsafe.com"; document.getElementById('out').innerHTML="Link: "+url; fetch(url);
        <\/script></body></html>`;
        try { 
            const h = await rootHandle.getFileHandle(name, {create:true}); 
            const w = await h.createWritable(); await w.write(content); await w.close(); 
            log("Demo created. Click Audit to scan.", "var(--success)"); 
            await buildTree(rootHandle, document.getElementById('tree-root')); 
        } catch(e) { log("Error: "+e.message, "var(--danger)"); }
    };

    // --- AUDIT & AUTO-LOGGING ---
    document.getElementById('auditBtn').onclick = async () => {
        log("Starting Scan...", "var(--warn)");
        let findings = [];
        
        // Patterns
        const patterns = [
            { id: "XSS", r: /\.innerHTML/, sev: "High" }, // Relaxed regex
            { id: "HTTP", r: /http:\/\//, sev: "Medium" }
        ];

        async function scan(h) {
            for await (const e of h.values()) {
                if(e.kind==='directory') await scan(e);
                else {
                    if(e.name === 'vulnerabilities.json') continue;
                    const t = await (await e.getFile()).text();
                    log(`Scanning ${e.name}...`);
                    patterns.forEach(p => {
                        if(p.r.test(t)) {
                            findings.push({ title: p.id + " Detected", desc: `Found in ${e.name}`, date: new Date().toISOString() });
                            log(`[!] ${p.id} found in ${e.name}`, "var(--danger)");
                        }
                    });
                }
            }
        }
        await scan(rootHandle);

        if(findings.length > 0) {
            document.getElementById('mitigateBtn').style.display='inline';
            
            // 1. Update UI Immediately (Memory)
            renderDB(findings); 
            
            // 2. Persist to Disk
            try {
                const fh = await rootHandle.getFileHandle('vulnerabilities.json', {create:true});
                // Read existing
                let current = [];
                try {
                    const txt = await (await fh.getFile()).text();
                    if(txt) current = JSON.parse(txt);
                } catch(e) { current = []; }
                
                // Append
                const updated = [...current, ...findings];
                
                // Write
                const w = await fh.createWritable(); 
                await w.write(JSON.stringify(updated, null, 2)); 
                await w.close();
                log(`Logged ${findings.length} issues to DB file.`, "var(--success)");
            } catch(e) { log("DB Write Failed: " + e.message, "var(--danger)"); }
        } else {
            log("Clean scan. No issues found.", "var(--success)");
        }
    };

    function renderDB(data) {
        const list = document.getElementById('dbList');
        list.innerHTML = "";
        if(data.length === 0) { list.innerHTML = "(No entries)"; return; }
        data.forEach(e => {
            list.innerHTML += `
            <div class="db-entry">
                <div class="db-title">${e.title}</div>
                <div class="db-desc">${e.desc}</div>
                <div class="db-meta">${new Date(e.date).toLocaleTimeString()}</div>
            </div>`;
        });
    }

    async function loadDB() {
        try {
            const fh = await rootHandle.getFileHandle('vulnerabilities.json');
            const txt = await (await fh.getFile()).text();
            const data = txt ? JSON.parse(txt) : [];
            renderDB(data);
        } catch(e) { /* Ignore read errors on init */ }
    }

    function applyMitigation() {
        editor.value = editor.value.replace(/\.innerHTML\s*=/g, ".textContent =").replace(/http:\/\//g, "https://");
        hContent.innerHTML = applyHighlight(editor.value) + "\n";
        log("Mitigation applied.", "var(--success)");
    }

    // --- FILE SYSTEM (Drag/Drop/Tree) ---
    async function moveEntry(name, src, dest, kind) {
        if(kind==='file') {
            const f = await (await src.getFileHandle(name)).getFile();
            const w = await (await dest.getFileHandle(name, {create:true})).createWritable();
            await w.write(f); await w.close(); await src.removeEntry(name);
        } else {
            const dSub = await src.getDirectoryHandle(name);
            const nSub = await dest.getDirectoryHandle(name, {create:true});
            for await (const e of dSub.values()) await moveEntry(e.name, dSub, nSub, e.kind);
            await src.removeEntry(name, {recursive:true});
        }
    }

    async function buildTree(handle, container) {
        container.innerHTML = "";
        const entries = []; for await (const e of handle.values()) entries.push(e);
        entries.sort((a,b) => (b.kind==='directory') - (a.kind==='directory') || a.name.localeCompare(b.name));
        
        if(entries.length===0) { container.innerHTML="<div style='padding:5px; color:#999; font-size:10px;'>(empty)</div>"; return; }

        for (const entry of entries) {
            const row = document.createElement('div');
            row.className = `tree-row ${currentFileHandle?.name === entry.name ? 'active' : ''}`;
            
            // Drag Logic
            row.draggable = true;
            row.ondragstart = e => { e.stopPropagation(); draggedItem = {name:entry.name, kind:entry.kind, parent:handle}; };

            if(entry.kind === 'directory') {
                row.innerHTML = `<span class="folder-icon">‚ñ∂</span> üìÅ ${entry.name}`;
                row.ondragover = e => { e.preventDefault(); e.stopPropagation(); row.classList.add('drag-over'); };
                row.ondragleave = e => { e.stopPropagation(); row.classList.remove('drag-over'); };
                row.ondrop = async e => {
                    e.preventDefault(); e.stopPropagation(); row.classList.remove('drag-over');
                    if(!draggedItem) return;
                    try {
                        const dest = await handle.getDirectoryHandle(entry.name);
                        await moveEntry(draggedItem.name, draggedItem.parent, dest, draggedItem.kind);
                        await buildTree(rootHandle, document.getElementById('tree-root'));
                    } catch(err) { log("Move failed.", "var(--danger)"); }
                };
                
                const sub = document.createElement('div'); sub.className = 'tree-item'; sub.style.display = 'none';
                row.onclick = e => {
                    e.stopPropagation();
                    const icon = row.querySelector('.folder-icon');
                    if(sub.style.display==='none'){ sub.style.display='block'; icon.style.transform='rotate(90deg)'; buildTree(entry, sub); }
                    else { sub.style.display='none'; icon.style.transform='rotate(0deg)'; }
                };
                container.appendChild(row); container.appendChild(sub);
            } else {
                row.innerHTML = `üìÑ ${entry.name}`;
                row.onclick = e => { e.stopPropagation(); loadFile(entry); };
                container.appendChild(row);
            }
        }
    }

    async function loadFile(h) {
        currentFileHandle = h;
        editor.value = sanitize(await (await h.getFile()).text());
        hContent.innerHTML = applyHighlight(editor.value) + "\n";
        document.getElementById('file-label').textContent = h.name;
        lineNumbers.innerHTML = Array.from({length: editor.value.split('\n').length}, (_, i) => i + 1).join('<br>');
    }

    // --- RUN & UTILS ---
    function sanitize(text) { return text.replace(/<span class="t-[a-z]+">/gi, "").replace(/<\/span>/gi, "").replace(/##[A-Z_]+##/g, ""); }
    function applyHighlight(text) {
        let code = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        code = code.replace(/(&lt;\/?[a-z1-6!]+)/gi, '##T_S##$1##T_E##');
        code = code.replace(/(\s)([a-z-]+)(?==)/gi, '$1##A_S##$2##A_E##');
        code = code.replace(/"(.*?)"/g, '##S_S##"$1"##S_E##');
        code = code.replace(/\b(let|const|var|function|return|if|else|class|async|await)\b/g, '##K_S##$1##K_E##');
        return code.replace(/##T_S##/g, '<span class="t-tag">').replace(/##T_E##/g, '</span>').replace(/##A_S##/g, '<span class="t-attr">').replace(/##A_E##/g, '</span>').replace(/##S_S##/g, '<span class="t-str">').replace(/##S_E##/g, '</span>').replace(/##K_S##/g, '<span class="t-key">').replace(/##K_E##/g, '</span>');
    }

    document.getElementById('runBtn').onclick = () => {
        if(runWindow && !runWindow.closed) runWindow.close();
        const hook = `<script>(function(){const netLog=(d)=>window.opener.postMessage({type:'network',...d},'*');const log=(m,a)=>window.opener.postMessage({type:'console',method:m,args:Array.from(a).map(String)},'*');console.log=function(){log('log',arguments)};console.error=function(){log('error',arguments)};window.onerror=(m)=>log('error',[m]);const originalFetch=window.fetch;window.fetch=async(...args)=>{const u=args[0]instanceof Request?args[0].url:args[0];const m=(args[1]&&args[1].method)||'GET';try{const r=await originalFetch.apply(this,args);netLog({url:u,method:m,status:r.status});return r}catch(e){netLog({url:u,method:m,status:'BLOCKED'});throw e}}})();<\/script>`;
        const blob = new Blob([`<html><head><title>Run Preview</title></head><body>${hook}${sanitize(editor.value)}</body></html>`], {type: 'text/html'});
        runWindow = window.open(URL.createObjectURL(blob), '_blank');
        log("Launched in new window.", "var(--primary)");
    };

    window.addEventListener('message', (e) => {
        if(e.data.type === 'network') {
            const d = document.createElement('div'); d.className='net-item'; 
            d.innerHTML = `<b style="color:#1877f2">${e.data.method}</b> ${e.data.url} (${e.data.status})`;
            document.getElementById('netList').prepend(d);
        }
        if(e.data.type === 'console') log(e.data.args.join(' '), e.data.method==='error'?'var(--danger)':null);
    });

    document.getElementById('saveBtn').onclick = async () => {
        const w = await currentFileHandle.createWritable(); await w.write(editor.value); await w.close(); log("Saved.");
    };
    
    document.getElementById('backupBtn').onclick = async () => {
        const zip = new JSZip();
        async function walk(h, folder) { for await (const e of h.values()) { if(e.kind==='directory') await walk(e, folder.folder(e.name)); else folder.file(e.name, await e.getFile()); }}
        await walk(rootHandle, zip);
        const a = document.createElement('a'); a.href = URL.createObjectURL(await zip.generateAsync({type:"blob"})); a.download = "opfs_project.zip"; a.click();
    };

    document.getElementById('newFolderBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getDirectoryHandle(n, {create:true}); await buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('newFileBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getFileHandle(n, {create:true}); await buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('wipeBtn').onclick = async () => { if(confirm("Wipe?")) { for await (const e of rootHandle.values()) await rootHandle.removeEntry(e.name,{recursive:true}); await buildTree(rootHandle,document.getElementById('tree-root')); renderDB([]); }};

    editor.oninput = () => { hContent.innerHTML = applyHighlight(editor.value) + "\n"; };
    editor.onscroll = () => { lineNumbers.scrollTop = editor.scrollTop; document.getElementById('highlighting').scrollTop = editor.scrollTop; };
</script>
</body>
</html>
