<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IDE v10.4: Tokenized Syntax Engine</title>
    <style>
        /* --- GEMINI THEME PALETTE --- */
        :root {
            --bg: #f0f4f9; --text: #1f1f1f; --sidebar: #ffffff; --border: #dfe3e7;
            --header: #ffffff; --header-text: #1f1f1f;
            --line-bg: #e1e5ea; --line-text: #747775;
            --accent: #0b57d0; --success: #146c2e; --warn: #ea8600; --danger: #b3261e;
            
            /* SYNTAX COLORS */
            --tag: #d93025;  /* Red (HTML Tags) */
            --attr: #e37400; /* Orange/Brown (Attributes) */
            --str: #188038;  /* Green (Strings) */
            --key: #a142f4;  /* Purple (JS Keywords) */
            --obj: #1a73e8;  /* Blue (document, window) */
            --comm: #747775; /* Gray (Comments) */
        }
        body.midnight {
            --bg: #000; --text: #0f0; --sidebar: #111; --border: #333;
            --header: #000; --header-text: #0f0; --line-bg: #111; --line-text: #0f0;
            --accent: #0f0; --tag: #ff5555; --attr: #f1fa8c; --str: #50fa7b; --key: #bd93f9; --obj: #8be9fd; --comm: #6272a4;
        }

        /* --- LAYOUT --- */
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: 'Google Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        header { 
            height: 45px; background: var(--header); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; 
        }

        .controls { 
            padding: 8px 15px; background: var(--sidebar); border-bottom: 1px solid var(--border); 
            display: flex; gap: 8px; align-items: center; flex-shrink: 0; flex-wrap: wrap; 
        }

        .main-layout { display: flex; flex: 1; overflow: hidden; }

        .sidebar { width: 340px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        
        .tab-row { display: flex; background: rgba(0,0,0,0.05); }
        .tab { 
            flex: 1; padding: 10px 0; text-align: center; font-size: 10px; font-weight: bold; 
            cursor: pointer; opacity: 0.6; border-bottom: 2px solid transparent; 
        }
        .tab.active { background: var(--sidebar); color: var(--accent); border-bottom: 2px solid var(--accent); opacity: 1; }
        
        .pane { display: none; flex: 1; flex-direction: column; padding: 10px; overflow-y: auto; }
        .pane.active { display: flex; }

        /* --- UI COMPONENTS --- */
        .tree-row { padding: 4px 0; cursor: pointer; display: flex; align-items: center; font-size: 13px; white-space: nowrap; }
        .tree-row:hover { background: rgba(0,0,0,0.05); }
        .tree-row.active { background: rgba(24, 119, 242, 0.1); color: var(--accent); font-weight: 600; }
        .tree-item { margin-left: 15px; border-left: 1px solid var(--border); }
        .folder-icon { width: 14px; text-align: center; display: inline-block; font-size: 10px; margin-right: 4px; }

        .db-entry { padding: 8px; border: 1px solid var(--border); border-left: 3px solid var(--danger); margin-bottom: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; }
        .search-res { padding: 5px; border-bottom: 1px solid var(--border); font-size: 11px; cursor: pointer; }
        .search-res:hover { background: rgba(0,0,0,0.05); }

        /* Fixed DB Input Section */
        .db-form { flex-shrink: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
        input[type="text"], .db-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 12px; background: var(--bg); color: var(--text); }
        
        button { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); cursor: pointer; font-size: 11px; font-weight: bold; background: #fff; color: #333; }
        .btn-p { background: var(--accent); color: #fff; border: none; }
        .btn-d { background: var(--danger); color: #fff; border: none; }

        /* --- EDITOR ENGINE --- */
        .workspace { flex: 1; display: grid; grid-template-rows: 1fr auto; min-width: 0; background: var(--bg); }
        .editor-container { position: relative; display: flex; overflow: hidden; }
        
        #line-numbers { 
            width: 40px; background: var(--line-bg); color: var(--line-text); text-align: right; 
            padding: 10px 5px; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5; 
            border-right: 1px solid var(--border); user-select: none; 
        }
        .editor-stack { flex: 1; position: relative; min-width: 0; }
        
        #editor, #highlighting { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; 
            font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5; white-space: pre; 
            box-sizing: border-box; 
        }
        #editor { color: transparent; background: transparent; caret-color: var(--text); z-index: 2; overflow: scroll; resize: none; outline: none; }
        #highlighting { color: var(--text); z-index: 1; pointer-events: none; overflow: hidden; }
        
        #console-container { height: 140px; background: #1e1e1e; color: #ccc; display: flex; flex-direction: column; transition: 0.2s; border-top: 2px solid var(--border); }
        .c-toolbar { padding: 5px 10px; background: #252526; font-size: 11px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; }
        #console { flex: 1; padding: 10px; font-family: monospace; font-size: 11px; overflow: auto; }

        /* SYNTAX CLASSES */
        .t-tag { color: var(--tag); font-weight: 700; } 
        .t-attr { color: var(--attr); } 
        .t-str { color: var(--str); } 
        .t-key { color: var(--key); font-weight: 600; }
        .t-obj { color: var(--obj); font-weight: 600; } 
        .t-comm { color: var(--comm); font-style: italic; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="gemini">

<header>
    <div>IDE v10.4 <span style="opacity:0.5; font-weight:400;">(Tokenized Highlighting)</span></div>
    <div id="status" style="font-size: 11px; opacity: 0.7;">Disconnected</div>
</header>

<div class="controls">
    <button class="btn-p" id="mountBtn">Initialize</button>
    <button class="btn-d" id="wipeBtn" disabled>Wipe</button>
    <div style="width:1px; height:16px; background:#ccc; margin:0 5px;"></div>
    <button id="runBtn" class="btn-p" disabled>‚ñ∂ Run in Window</button>
    <button id="auditBtn" disabled>üõ°Ô∏è Audit</button>
    <button id="saveBtn" disabled>Save</button>
    <button id="newFileBtn" disabled>+ File</button>
    <button id="newFolderBtn" disabled>+ Folder</button>
    <button id="demoBtn" disabled>Demo</button>
    <button id="backupBtn" disabled>üíæ ZIP</button>
</div>

<div class="main-layout">
    <div class="sidebar">
        <div class="tab-row">
            <div class="tab active" onclick="tab('files')">FILES</div>
            <div class="tab" onclick="tab('db')">DB</div>
            <div class="tab" onclick="tab('net')">NET</div>
            <div class="tab" onclick="tab('tools')">TOOLS</div>
        </div>
        
        <div id="filesPane" class="pane active">
            <div id="tree-root"></div>
        </div>

        <div id="dbPane" class="pane">
            <div class="db-form">
                <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--accent);">ADD VULNERABILITY</div>
                <input type="text" id="dbTitle" class="db-input" placeholder="Title (e.g. XSS)">
                <input type="text" id="dbDesc" class="db-input" placeholder="Description...">
                <input type="text" id="dbMit" class="db-input" placeholder="Fix/Mitigation...">
                <button class="btn-p" style="width:100%;" id="addDbEntryBtn">Add Entry</button>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <b style="font-size:11px;">LOG ENTRIES</b>
                <span onclick="loadDB()" style="cursor:pointer; color:var(--accent); font-size:10px;">REFRESH</span>
            </div>
            <div id="dbList"></div>
        </div>

        <div id="netPane" class="pane">
            <div style="font-size:11px; opacity:0.7; margin-bottom:5px;">LIVE TRAFFIC</div>
            <div id="netList"></div>
        </div>

        <div id="toolsPane" class="pane">
            <div style="font-weight:bold; font-size:11px; margin-bottom:5px;">DEEP SEARCH</div>
            <input type="text" id="searchAll" placeholder="Search in all files...">
            <button class="btn-p" style="width:100%" id="searchAllBtn">Search</button>
            <div id="searchResults" style="margin-top:10px; max-height:120px; overflow-y:auto; border:1px solid var(--border);"></div>
            <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
            <div style="font-weight:bold; font-size:11px; margin-bottom:5px;">GLOBAL REPLACE</div>
            <input type="text" id="gFind" placeholder="Find text...">
            <input type="text" id="gReplace" placeholder="Replace with...">
            <button class="btn-p" style="width:100%" id="gReplaceBtn">Replace All</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
            <div style="font-weight:bold; font-size:11px; margin-bottom:5px;">THEME</div>
            <button onclick="document.body.className='gemini'" style="width:100%">Gemini Light</button>
            <button onclick="document.body.className='midnight'" style="width:100%">Midnight Dark</button>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-container">
            <div id="line-numbers">1</div>
            <div class="editor-stack">
                <pre id="highlighting"><code id="h-content"></code></pre>
                <textarea id="editor" spellcheck="false" wrap="off" placeholder="Initialize OPFS to start..."></textarea>
            </div>
        </div>
        <div id="console-container">
            <div class="c-toolbar" onclick="document.getElementById('console-container').classList.toggle('minimized')">
                <span>CONSOLE</span><span>‚ñº</span>
            </div>
            <div id="console"></div>
        </div>
    </div>
</div>

<script>
    let rootHandle, currentHandle;
    const editor = document.getElementById('editor');
    const high = document.getElementById('highlighting');
    const hContent = document.getElementById('h-content');
    const lNums = document.getElementById('line-numbers');
    const con = document.getElementById('console');

    // --- TAB LOGIC ---
    function tab(id) {
        document.querySelectorAll('.tab, .pane').forEach(e => e.classList.remove('active'));
        document.querySelector(`.tab[onclick="tab('${id}')"]`).classList.add('active');
        document.getElementById(id+'Pane').classList.add('active');
    }

    // --- EDITOR SYNC ---
    editor.onscroll = () => {
        high.scrollTop = editor.scrollTop;
        high.scrollLeft = editor.scrollLeft;
        lNums.scrollTop = editor.scrollTop;
    };
    
    // --- TOKENIZED SYNTAX HIGHLIGHTER (THE FIX) ---
    const updateHigh = (text) => {
        // 1. Escape HTML
        let code = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        // 2. Tokenize (Hide) HTML Tags & Strings to prevent collisions
        const tokens = [];
        
        // Hide Strings first
        code = code.replace(/"(.*?)"/g, (m) => { tokens.push(`<span class="t-str">${m}</span>`); return `___TOK_${tokens.length-1}___`; });
        code = code.replace(/'(.*?)'/g, (m) => { tokens.push(`<span class="t-str">${m}</span>`); return `___TOK_${tokens.length-1}___`; });

        // Hide HTML Tags (Beautify them while hiding)
        code = code.replace(/(&lt;\/?[a-z0-9]+.*?>)/gi, (m) => { 
            // Colorize the tag content BEFORE hiding it
            let colored = m.replace(/(&lt;\/?[a-z0-9]+)/gi, '<span class="t-tag">$1</span>'); // Tag Name (Red)
            colored = colored.replace(/(\s)([a-z-]+)(?==)/gi, '$1<span class="t-attr">$2</span>'); // Attributes (Orange)
            tokens.push(colored); 
            return `___TOK_${tokens.length-1}___`; 
        });

        // 3. Highlight JavaScript (Safe now!)
        // Keywords (Purple)
        const keywords = "\\b(const|let|var|function|return|if|else|async|await|class|new|try|catch|for|while)\\b";
        code = code.replace(new RegExp(keywords, 'g'), '<span class="t-key">$1</span>');
        
        // Objects (Blue)
        const objects = "\\b(document|window|console|fetch|navigator|localStorage)\\b";
        code = code.replace(new RegExp(objects, 'g'), '<span class="t-obj">$1</span>');
        
        // Comments (Gray)
        code = code.replace(/(\/\/.*)/g, '<span class="t-comm">$1</span>');

        // 4. Restore Tokens
        code = code.replace(/___TOK_(\d+)___/g, (m, i) => tokens[i]);

        hContent.innerHTML = code + "\n";
        lNums.innerHTML = Array.from({length: text.split('\n').length}, (_, i) => i + 1).join('<br>');
    };
    editor.oninput = () => updateHigh(editor.value);

    // --- OPFS INIT ---
    const log = (m, type='info') => {
        const d = document.createElement('div'); d.textContent = `> ${m}`;
        if(type==='err') d.style.color = 'var(--danger)';
        if(type==='ok') d.style.color = 'var(--success)';
        con.appendChild(d); con.scrollTop = con.scrollHeight;
    };

    document.getElementById('mountBtn').onclick = async () => {
        try {
            rootHandle = await navigator.storage.getDirectory();
            try { await rootHandle.getFileHandle('vuln_db.json'); }
            catch { const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true}); const w = await fh.createWritable(); await w.write("[]"); await w.close(); }
            
            await buildTree(rootHandle, document.getElementById('tree-root'));
            document.querySelectorAll('button').forEach(b => b.disabled = false);
            loadDB();
            log("System Initialized.", "ok");
        } catch(e) { log(e.message, 'err'); }
    };

    // --- FILE TREE ---
    async function buildTree(dirHandle, container) {
        container.innerHTML = "";
        const entries = [];
        for await (const e of dirHandle.values()) entries.push(e);
        entries.sort((a,b) => (b.kind==='directory') - (a.kind==='directory') || a.name.localeCompare(b.name));
        
        if(entries.length === 0) {
            container.innerHTML = "<div style='font-size:10px; color:#999; padding-left:15px;'>(empty)</div>";
            return;
        }

        for (const e of entries) {
            if(e.name === 'vuln_db.json') continue;
            
            const row = document.createElement('div');
            row.className = 'tree-row';
            
            if (e.kind === 'directory') {
                row.innerHTML = `<span class="folder-icon">‚ñ∂</span> üìÅ ${e.name}`;
                const sub = document.createElement('div');
                sub.className = 'tree-item';
                sub.style.display = 'none';
                
                row.onclick = async (evt) => {
                    evt.stopPropagation();
                    const icon = row.querySelector('.folder-icon');
                    if (sub.style.display === 'none') {
                        sub.style.display = 'block';
                        icon.innerHTML = '‚ñº';
                        await buildTree(e, sub);
                    } else {
                        sub.style.display = 'none';
                        icon.innerHTML = '‚ñ∂';
                    }
                };
                container.appendChild(row);
                container.appendChild(sub);
            } else {
                row.innerHTML = `üìÑ ${e.name}`;
                row.onclick = (evt) => { evt.stopPropagation(); loadFile(e); };
                container.appendChild(row);
            }
        }
    }

    async function loadFile(h) {
        currentHandle = h;
        const text = await (await h.getFile()).text();
        editor.value = text;
        updateHigh(text);
        document.getElementById('status').textContent = `Editing: ${h.name}`;
    }

    // --- DB & AUDIT ---
    async function loadDB() {
        try {
            const fh = await rootHandle.getFileHandle('vuln_db.json');
            const txt = await (await fh.getFile()).text();
            const list = document.getElementById('dbList');
            list.innerHTML = "";
            const data = txt ? JSON.parse(txt) : [];
            if(data.length === 0) list.innerHTML = "<div style='font-size:10px;opacity:0.5'>(Empty)</div>";
            else data.forEach(x => {
                list.innerHTML += `<div class="db-entry"><div class="db-title">${x.title}</div><div class="db-desc">${x.desc}</div></div>`;
            });
        } catch(e){ log("DB Load Error", "err"); }
    }

    document.getElementById('auditBtn').onclick = async () => {
        log("Scanning...", "warn");
        const findings = [];
        async function scan(dir) {
            for await (const e of dir.values()) {
                if(e.kind==='directory') await scan(e);
                else {
                    if(e.name === 'vuln_db.json') continue;
                    const t = await (await e.getFile()).text();
                    if(t.includes('innerHTML')) findings.push({title:"XSS Risk", desc:`Found in ${e.name}`});
                    if(t.includes('http:')) findings.push({title:"Insecure HTTP", desc:`Found in ${e.name}`});
                }
            }
        }
        await scan(rootHandle);
        
        if(findings.length > 0) {
            log(`Found ${findings.length} issues. Saving...`, "err");
            const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true});
            const old = await (await fh.getFile()).text();
            const db = old ? JSON.parse(old) : [];
            const w = await fh.createWritable();
            await w.write(JSON.stringify([...db, ...findings]));
            await w.close();
            loadDB();
        } else { log("Clean scan.", "ok"); }
    };

    document.getElementById('addDbEntryBtn').onclick = async () => {
        const title = document.getElementById('dbTitle').value;
        const desc = document.getElementById('dbDesc').value;
        if(!title) return;
        const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true});
        const t = await (await fh.getFile()).text();
        const data = t ? JSON.parse(t) : [];
        data.push({title, desc});
        const w = await fh.createWritable(); await w.write(JSON.stringify(data)); await w.close();
        loadDB();
        log("Entry saved.", "ok");
    };

    // --- SEARCH ---
    document.getElementById('searchAllBtn').onclick = async () => {
        const q = document.getElementById('searchAll').value.toLowerCase();
        const res = document.getElementById('searchResults');
        res.innerHTML = "";
        if(!q) return;
        async function scan(dir) {
            for await (const e of dir.values()) {
                if(e.kind==='directory') await scan(e);
                else {
                    const t = await (await e.getFile()).text();
                    if(t.toLowerCase().includes(q)) {
                        const d = document.createElement('div');
                        d.className = 'search-res';
                        d.innerHTML = `Found in: <b>${e.name}</b>`;
                        d.onclick = () => loadFile(e);
                        res.appendChild(d);
                    }
                }
            }
        }
        await scan(rootHandle);
        if(res.children.length===0) res.innerHTML = "<div style='font-size:10px'>No matches.</div>";
    };

    // --- UTILS ---
    document.getElementById('runBtn').onclick = () => {
        const hook = `<script>
            (function(){
                const send=(t,d)=>window.opener.postMessage({type:t,...d},'*');
                console.log=function(){send('console',{msg:Array.from(arguments).join(' ')})};
                window.onerror=(m)=>send('console',{msg:'ERR: '+m});
                const of=window.fetch;
                window.fetch=async(...a)=>{
                    try{const r=await of.apply(this,a); send('network',{m:'GET',u:a[0].url||a[0],s:r.status}); return r;}
                    catch(e){send('network',{m:'GET',u:a[0],s:'ERR'}); throw e;}
                }
            })();
        <\/script>`;
        const blob = new Blob([hook + editor.value], {type:'text/html'});
        window.open(URL.createObjectURL(blob), '_blank');
        log("Run in new window.", "ok");
    };

    window.addEventListener('message', (e) => {
        if(e.data.type === 'network') {
            const d = document.createElement('div'); d.style.fontSize="11px"; d.style.borderBottom="1px solid #eee";
            d.textContent = `[${e.data.m}] ${e.data.u} (${e.data.s})`;
            document.getElementById('netList').prepend(d);
        }
        if(e.data.type === 'console') log(e.data.msg);
    });

    document.getElementById('saveBtn').onclick = async () => {
        if(currentHandle) { const w = await currentHandle.createWritable(); await w.write(editor.value); await w.close(); log("Saved.", "ok"); }
    };
    
    document.getElementById('gReplaceBtn').onclick = async () => {
        const f = document.getElementById('gFind').value; const r = document.getElementById('gReplace').value;
        if(!f) return;
        async function run(dir) { for await (const e of dir.values()) { if(e.kind==='directory') await run(e); else { let t = await (await e.getFile()).text(); if(t.includes(f)) { const w = await e.createWritable(); await w.write(t.split(f).join(r)); await w.close(); }}}}
        await run(rootHandle); log("Replaced.");
    };

    document.getElementById('demoBtn').onclick = async () => {
        const h = await rootHandle.getFileHandle('demo.html', {create:true});
        const w = await h.createWritable(); await w.write('<html><body><h1>XSS</h1><script>document.body.innerHTML="bad"; fetch("/test")<\/script></body></html>'); await w.close();
        await buildTree(rootHandle, document.getElementById('tree-root'));
        log("Demo Created.", "ok");
    };

    document.getElementById('backupBtn').onclick = async () => {
        const zip = new JSZip();
        async function walk(dir, folder) { for await (const e of dir.values()) { if(e.kind==='directory') await walk(e, folder.folder(e.name)); else folder.file(e.name, await e.getFile()); }}
        await walk(rootHandle, zip);
        const a = document.createElement('a'); a.href = URL.createObjectURL(await zip.generateAsync({type:"blob"})); a.download = "project.zip"; a.click();
    };

    document.getElementById('newFolderBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getDirectoryHandle(n, {create:true}); await buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('newFileBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getFileHandle(n, {create:true}); await buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('wipeBtn').onclick = async () => { if(confirm("Wipe?")) { for await (const e of rootHandle.values()) await rootHandle.removeEntry(e.name,{recursive:true}); await buildTree(rootHandle,document.getElementById('tree-root')); loadDB(); }};
</script>
</body>
</html>
