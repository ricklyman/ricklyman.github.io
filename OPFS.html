<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IDE v11.4: State-Machine Syntax</title>
    <style>
        /* --- GEMINI THEME --- */
        :root {
            --bg: #f0f4f9; --text: #1f1f1f; --sidebar: #ffffff; --border: #dfe3e7;
            --header: #ffffff; --header-text: #1f1f1f;
            --line-bg: #e1e5ea; --line-text: #747775;
            --accent: #0b57d0; --success: #146c2e; --warn: #ea8600; --danger: #b3261e;
            
            /* SYNTAX COLORS (Classes) */
            --c-tag: #d93025;  /* Red */
            --c-attr: #e37400; /* Orange */
            --c-str: #188038;  /* Green */
            --c-key: #a142f4;  /* Purple */
            --c-obj: #1a73e8;  /* Blue */
            --c-com: #747775;  /* Gray */
        }
        body.midnight {
            --bg: #000; --text: #0f0; --sidebar: #111; --border: #333;
            --header: #000; --header-text: #0f0; --line-bg: #111; --line-text: #0f0;
            --accent: #0f0; --c-tag: #ff5555; --c-attr: #f1fa8c; --c-str: #50fa7b; 
            --c-key: #bd93f9; --c-obj: #8be9fd; --c-com: #6272a4;
        }

        /* --- LAYOUT --- */
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: 'Google Sans Mono', monospace; background: var(--bg); color: var(--text); overflow: hidden; }
        
        header { 
            height: 45px; background: var(--header); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; font-family: system-ui;
        }

        .controls { 
            padding: 8px 15px; background: var(--sidebar); border-bottom: 1px solid var(--border); 
            display: flex; gap: 8px; align-items: center; flex-shrink: 0; flex-wrap: wrap; 
        }

        .main-layout { display: flex; flex: 1; overflow: hidden; }

        .sidebar { width: 340px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        
        .tab-row { display: flex; background: rgba(0,0,0,0.05); }
        .tab { 
            flex: 1; padding: 10px 0; text-align: center; font-size: 10px; font-weight: bold; font-family: system-ui;
            cursor: pointer; opacity: 0.6; border-bottom: 2px solid transparent; 
        }
        .tab.active { background: var(--sidebar); color: var(--accent); border-bottom: 2px solid var(--accent); opacity: 1; }
        
        .pane { display: none; flex: 1; flex-direction: column; padding: 10px; overflow-y: auto; }
        .pane.active { display: flex; }

        /* Tree UI */
        .tree-row { 
            padding: 4px 6px; cursor: pointer; display: flex; align-items: center; font-size: 13px; 
            white-space: nowrap; border: 1px solid transparent; border-radius: 4px; user-select: none;
        }
        .tree-row:hover { background: rgba(0,0,0,0.05); }
        .tree-row.active { background: rgba(11, 87, 208, 0.1); color: var(--accent); font-weight: 600; }
        .drag-over { background: rgba(11, 87, 208, 0.15) !important; border: 1px dashed var(--accent) !important; }

        .tree-item { margin-left: 15px; border-left: 1px solid var(--border); }
        .folder-icon { width: 14px; text-align: center; display: inline-block; font-size: 10px; margin-right: 4px; }

        /* DB & Search */
        .db-entry { padding: 8px; border: 1px solid var(--border); border-left: 3px solid var(--danger); margin-bottom: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; font-family: system-ui; }
        .search-res { padding: 5px; border-bottom: 1px solid var(--border); font-size: 11px; cursor: pointer; font-family: system-ui; }
        .search-res:hover { background: rgba(0,0,0,0.05); }

        .db-form { flex-shrink: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
        input[type="text"], .db-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 12px; background: var(--bg); color: var(--text); }
        
        button { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); cursor: pointer; font-size: 11px; font-weight: bold; background: #fff; color: #333; font-family: system-ui; }
        .btn-p { background: var(--accent); color: #fff; border: none; }
        .btn-d { background: var(--danger); color: #fff; border: none; }

        /* --- EDITOR ENGINE --- */
        .workspace { flex: 1; display: grid; grid-template-rows: 1fr auto; min-width: 0; background: var(--bg); }
        .editor-container { position: relative; display: flex; overflow: hidden; }
        
        #line-numbers { 
            width: 45px; background: var(--line-bg); color: var(--line-text); text-align: right; 
            padding: 10px 5px; font-size: 13px; line-height: 1.5; 
            border-right: 1px solid var(--border); user-select: none; 
        }
        .editor-stack { flex: 1; position: relative; min-width: 0; }
        
        #editor, #highlighting { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; 
            font-size: 13px; line-height: 1.5; white-space: pre; box-sizing: border-box; 
        }
        #editor { color: transparent; background: transparent; caret-color: var(--text); z-index: 2; overflow: scroll; resize: none; outline: none; }
        #highlighting { color: var(--text); z-index: 1; pointer-events: none; overflow: hidden; }
        
        #console-container { height: 140px; background: #1e1e1e; color: #ccc; display: flex; flex-direction: column; transition: 0.2s; border-top: 2px solid var(--border); }
        .c-toolbar { padding: 5px 10px; background: #252526; font-size: 11px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; font-family: system-ui; }
        #console { flex: 1; padding: 10px; font-size: 11px; overflow: auto; }

        /* SYNTAX CLASSES (Strict !important) */
        .c-tag { color: var(--c-tag) !important; font-weight: 700; }
        .c-attr { color: var(--c-attr) !important; }
        .c-str { color: var(--c-str) !important; }
        .c-key { color: var(--c-key) !important; font-weight: 600; }
        .c-obj { color: var(--c-obj) !important; font-weight: 600; }
        .c-com { color: var(--c-com) !important; font-style: italic; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="gemini">

<header>
    <div>IDE v11.4 <span style="opacity:0.5; font-weight:400;">(State-Machine Syntax)</span></div>
    <div id="status" style="font-size: 11px; opacity: 0.7;">Disconnected</div>
</header>

<div class="controls">
    <button class="btn-p" id="mountBtn">Initialize</button>
    <button class="btn-d" id="wipeBtn" disabled>Wipe</button>
    <div style="width:1px; height:16px; background:#ccc; margin:0 5px;"></div>
    <button id="runBtn" class="btn-p" disabled>‚ñ∂ Run</button>
    <button id="auditBtn" disabled>üõ°Ô∏è Audit</button>
    <button id="saveBtn" disabled>Save</button>
    <button id="newFileBtn" disabled>+ File</button>
    <button id="newFolderBtn" disabled>+ Folder</button>
    <button id="demoBtn" disabled>Demo</button>
    <button id="backupBtn" disabled>üíæ ZIP</button>
</div>

<div class="main-layout">
    <div class="sidebar">
        <div class="tab-row">
            <div class="tab active" onclick="tab('files')">FILES</div>
            <div class="tab" onclick="tab('db')">DB</div>
            <div class="tab" onclick="tab('net')">NET</div>
            <div class="tab" onclick="tab('tools')">TOOLS</div>
        </div>
        
        <div id="filesPane" class="pane active">
            <div id="tree-root-header" class="tree-row" style="font-weight:bold; color:var(--accent);">üìÅ ROOT</div>
            <div id="tree-root"></div>
        </div>

        <div id="dbPane" class="pane">
            <div class="db-form">
                <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--accent);">ADD LOG</div>
                <input type="text" id="dbTitle" class="db-input" placeholder="Title...">
                <input type="text" id="dbDesc" class="db-input" placeholder="Description...">
                <button class="btn-p" style="width:100%;" id="addDbEntryBtn">Add Entry</button>
            </div>
            <div id="dbList"></div>
        </div>

        <div id="netPane" class="pane">
            <div style="font-size:11px; opacity:0.7; margin-bottom:5px;">LIVE TRAFFIC</div>
            <div id="netList"></div>
        </div>

        <div id="toolsPane" class="pane">
            <input type="text" id="searchAll" placeholder="Search files...">
            <button class="btn-p" style="width:100%" id="searchAllBtn">Search</button>
            <div id="searchResults" style="margin-top:10px; border:1px solid var(--border); max-height:100px; overflow:auto;"></div>
            <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
            <input type="text" id="gFind" placeholder="Find...">
            <input type="text" id="gReplace" placeholder="Replace...">
            <button class="btn-p" style="width:100%" id="gReplaceBtn">Replace All</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid var(--border);">
            <button onclick="document.body.className='gemini'" style="width:100%">Light</button>
            <button onclick="document.body.className='midnight'" style="width:100%">Dark</button>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-container">
            <div id="line-numbers">1</div>
            <div class="editor-stack">
                <pre id="highlighting"><code id="h-content"></code></pre>
                <textarea id="editor" spellcheck="false" wrap="off" placeholder="Initialize OPFS to start..."></textarea>
            </div>
        </div>
        <div id="console-container">
            <div class="c-toolbar" onclick="document.getElementById('console-container').classList.toggle('minimized')">
                <span>CONSOLE</span><span>‚ñº</span>
            </div>
            <div id="console"></div>
        </div>
    </div>
</div>

<script>
    let rootHandle, currentHandle;
    let draggedItem = null;

    const editor = document.getElementById('editor');
    const high = document.getElementById('highlighting');
    const hContent = document.getElementById('h-content');
    const lNums = document.getElementById('line-numbers');
    const con = document.getElementById('console');

    function tab(id) {
        document.querySelectorAll('.tab, .pane').forEach(e => e.classList.remove('active'));
        document.querySelector(`.tab[onclick="tab('${id}')"]`).classList.add('active');
        document.getElementById(id+'Pane').classList.add('active');
    }

    editor.onscroll = () => {
        high.scrollTop = editor.scrollTop;
        high.scrollLeft = editor.scrollLeft;
        lNums.scrollTop = editor.scrollTop;
    };
    
    // --- STATE-MACHINE SYNTAX ENGINE (ARTIFACT PROOF) ---
    // This function parses the text character by character. 
    // It maintains a 'state' (CODE, TAG, ATTR, STRING) to decide colors.
    // It builds the output string sequentially, so it can never 'see' text it has already colored.
    const updateHigh = (text) => {
        const keywords = new Set(["const","let","var","function","return","if","else","class","new","async","await","try","catch","for","while"]);
        const globals = new Set(["document","window","console","fetch","navigator"]);
        
        let out = "";
        let i = 0;
        let state = "CODE"; // States: CODE, TAG, TAG_SPACE, STRING_Q, STRING_A, COMMENT
        
        // Helper to escape HTML characters
        const esc = (s) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        while (i < text.length) {
            const char = text[i];

            if (state === "CODE") {
                if (char === '<' && text[i+1] !== ' ') {
                    state = "TAG";
                    out += "&lt;<span class='c-tag'>";
                } else if (char === '"') {
                    state = "STRING_Q";
                    out += "<span class='c-str'>\"";
                } else if (char === "'") {
                    state = "STRING_A";
                    out += "<span class='c-str'>'";
                } else if (char === '/' && text[i+1] === '/') {
                    state = "COMMENT";
                    out += "<span class='c-com'>//";
                    i++;
                } else if (/[a-zA-Z_$]/.test(char)) {
                    // Start of a word
                    let word = "";
                    while(i < text.length && /[a-zA-Z0-9_$]/.test(text[i])) {
                        word += text[i++];
                    }
                    i--; // Backtrack one since main loop increments
                    
                    if (keywords.has(word)) out += `<span class='c-key'>${word}</span>`;
                    else if (globals.has(word)) out += `<span class='c-obj'>${word}</span>`;
                    else out += word;
                } else {
                    out += esc(char);
                }
            } 
            else if (state === "TAG") {
                if (char === ' ' || char === '>') {
                    out += "</span>"; // End tag name span
                    if (char === '>') {
                        out += "&gt;";
                        state = "CODE";
                    } else {
                        out += " ";
                        state = "TAG_SPACE";
                    }
                } else {
                    out += esc(char);
                }
            }
            else if (state === "TAG_SPACE") {
                if (char === '>') {
                    state = "CODE";
                    out += "&gt;";
                } else if (char === '"') {
                    state = "STRING_Q_IN_TAG";
                    out += "<span class='c-str'>\"";
                } else if (/[a-zA-Z-]/.test(char)) {
                    // Start attribute
                    out += "<span class='c-attr'>";
                    while(i < text.length && /[a-zA-Z0-9-]/.test(text[i])) {
                        out += text[i++];
                    }
                    out += "</span>";
                    i--;
                } else {
                    out += esc(char);
                }
            }
            else if (state === "STRING_Q" || state === "STRING_Q_IN_TAG") {
                out += esc(char);
                if (char === '"') {
                    out += "</span>";
                    state = state === "STRING_Q" ? "CODE" : "TAG_SPACE";
                }
            }
            else if (state === "STRING_A") {
                out += esc(char);
                if (char === "'") {
                    out += "</span>";
                    state = "CODE";
                }
            }
            else if (state === "COMMENT") {
                out += esc(char);
                if (char === '\n') {
                    out += "</span>";
                    state = "CODE";
                }
            }
            
            i++;
        }
        
        // Close any open spans at EOF
        if (state !== "CODE" && state !== "TAG_SPACE") out += "</span>";

        hContent.innerHTML = out + "\n";
        lNums.innerHTML = Array.from({length: text.split('\n').length}, (_, i) => i + 1).join('<br>');
    };

    editor.oninput = () => updateHigh(editor.value);

    // --- LOGGING ---
    const log = (m, type='info') => {
        const d = document.createElement('div'); d.textContent = `> ${m}`;
        if(type==='err') d.style.color = 'var(--danger)';
        if(type==='ok') d.style.color = 'var(--success)';
        con.appendChild(d); con.scrollTop = con.scrollHeight;
    };

    // --- INIT ---
    document.getElementById('mountBtn').onclick = async () => {
        try {
            rootHandle = await navigator.storage.getDirectory();
            try { await rootHandle.getFileHandle('vuln_db.json'); }
            catch { const fh = await rootHandle.getFileHandle('vuln_db.json', {create:true}); const w = await fh.createWritable(); await w.write("[]"); await w.close(); }
            
            // ROOT DROP TARGET
            const rootHead = document.getElementById('tree-root-header');
            rootHead.ondragover = e => { e.preventDefault(); rootHead.classList.add('drag-over'); };
            rootHead.ondragleave = () => rootHead.classList.remove('drag-over');
            rootHead.ondrop = async e => {
                e.preventDefault(); rootHead.classList.remove('drag-over');
                if(draggedItem && draggedItem.parent !== rootHandle) {
                    await moveEntry(draggedItem.name, draggedItem.parent, rootHandle, draggedItem.kind);
                    buildTree(rootHandle, document.getElementById('tree-root'));
                }
            };

            await buildTree(rootHandle, document.getElementById('tree-root'));
            document.querySelectorAll('button').forEach(b => b.disabled = false);
            loadDB();
            log("System Ready.", "ok");
        } catch(e) { log(e.message, 'err'); }
    };

    // --- DRAG & DROP LOGIC ---
    async function moveEntry(name, srcDir, destDir, kind) {
        try {
            if(kind === 'file') {
                const srcH = await srcDir.getFileHandle(name);
                const file = await srcH.getFile();
                const destH = await destDir.getFileHandle(name, {create:true});
                const w = await destH.createWritable();
                await w.write(file); await w.close();
            } else {
                await destDir.getDirectoryHandle(name, {create:true});
                log("Folder moved (content check required)", "warn");
            }
            await srcDir.removeEntry(name);
            log(`Moved ${name}`, "ok");
        } catch(e) { log("Move Error: "+e.message, "err"); }
    }

    // --- FILE TREE ---
    async function buildTree(dirHandle, container) {
        container.innerHTML = "";
        const entries = [];
        for await (const e of dirHandle.values()) entries.push(e);
        entries.sort((a,b) => (b.kind==='directory') - (a.kind==='directory') || a.name.localeCompare(b.name));
        
        if(entries.length === 0) {
            container.innerHTML = "<div style='font-size:10px; color:#999; padding-left:15px;'>(empty)</div>";
            return;
        }

        for (const e of entries) {
            if(e.name === 'vuln_db.json') continue;
            
            const row = document.createElement('div');
            row.className = 'tree-row';
            
            // DRAG EVENTS
            row.draggable = true;
            row.ondragstart = (evt) => {
                evt.stopPropagation();
                draggedItem = { name: e.name, kind: e.kind, parent: dirHandle };
            };

            if (e.kind === 'directory') {
                row.innerHTML = `<span class="folder-icon">‚ñ∂</span> üìÅ ${e.name}`;
                
                // DROP EVENTS
                row.ondragover = (evt) => { evt.preventDefault(); evt.stopPropagation(); row.classList.add('drag-over'); };
                row.ondragleave = (evt) => { evt.stopPropagation(); row.classList.remove('drag-over'); };
                row.ondrop = async (evt) => {
                    evt.preventDefault(); evt.stopPropagation(); row.classList.remove('drag-over');
                    if(draggedItem) {
                        const dest = await dirHandle.getDirectoryHandle(e.name);
                        await moveEntry(draggedItem.name, draggedItem.parent, dest, draggedItem.kind);
                        buildTree(rootHandle, document.getElementById('tree-root'));
                    }
                };

                const sub = document.createElement('div');
                sub.className = 'tree-item';
                sub.style.display = 'none';
                
                row.onclick = async (evt) => {
                    evt.stopPropagation();
                    const icon = row.querySelector('.folder-icon');
                    if (sub.style.display === 'none') {
                        sub.style.display = 'block'; icon.innerHTML = '‚ñº';
                        await buildTree(e, sub);
                    } else {
                        sub.style.display = 'none'; icon.innerHTML = '‚ñ∂';
                    }
                };
                container.appendChild(row); container.appendChild(sub);
            } else {
                row.innerHTML = `üìÑ ${e.name}`;
                row.onclick = (evt) => { evt.stopPropagation(); loadFile(e); };
                container.appendChild(row);
            }
        }
    }

    async function loadFile(h) {
        currentHandle = h;
        const text = await (await h.getFile()).text();
        editor.value = text;
        updateHigh(text);
        document.getElementById('status').textContent = `Editing: ${h.name}`;
    }

    // --- DB & UTILS ---
    async function loadDB() {
        try {
            const fh = await rootHandle.getFileHandle('vuln_db.json');
            const txt = await (await fh.getFile()).text();
            const list = document.getElementById('dbList');
            list.innerHTML = "";
            const data = txt ? JSON.parse(txt) : [];
            data.forEach(x => list.innerHTML += `<div class="db-entry"><b>${x.t}</b><br>${x.d}</div>`);
        } catch(e){}
    }

    document.getElementById('addDbEntryBtn').onclick = async () => {
        const t = document.getElementById('dbTitle').value;
        const d = document.getElementById('dbDesc').value;
        if(!t) return;
        const fh = await rootHandle.getFileHandle('vuln_db.json');
        const old = await (await fh.getFile()).text();
        const data = old ? JSON.parse(old) : [];
        data.push({t, d});
        const w = await fh.createWritable(); await w.write(JSON.stringify(data)); await w.close();
        loadDB(); log("Logged.", "ok");
    };

    document.getElementById('runBtn').onclick = () => {
        const blob = new Blob([editor.value], {type:'text/html'});
        window.open(URL.createObjectURL(blob), '_blank');
        log("Opened Preview.", "ok");
    };

    document.getElementById('saveBtn').onclick = async () => {
        if(currentHandle) { const w = await currentHandle.createWritable(); await w.write(editor.value); await w.close(); log("Saved.", "ok"); }
    };

    document.getElementById('searchAllBtn').onclick = async () => {
        const q = document.getElementById('searchAll').value;
        const res = document.getElementById('searchResults');
        res.innerHTML = "";
        async function scan(dir) {
            for await (const e of dir.values()) {
                if(e.kind==='directory') await scan(e);
                else {
                    const t = await (await e.getFile()).text();
                    if(t.includes(q)) {
                        const d = document.createElement('div');
                        d.className = 'search-res'; d.textContent = `Found in ${e.name}`;
                        d.onclick = () => loadFile(e);
                        res.appendChild(d);
                    }
                }
            }
        }
        await scan(rootHandle);
    };

    document.getElementById('newFileBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getFileHandle(n, {create:true}); buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('newFolderBtn').onclick = async () => { const n = prompt("Name:"); if(n) { await rootHandle.getDirectoryHandle(n, {create:true}); buildTree(rootHandle, document.getElementById('tree-root')); }};
    document.getElementById('wipeBtn').onclick = async () => { if(confirm("Wipe?")) { for await (const e of rootHandle.values()) await rootHandle.removeEntry(e.name,{recursive:true}); await buildTree(rootHandle,document.getElementById('tree-root')); }};
    document.getElementById('backupBtn').onclick = async () => { const zip = new JSZip(); async function walk(dir, f) { for await (const e of dir.values()) if(e.kind==='file') f.file(e.name, await e.getFile()); else await walk(e, f.folder(e.name)); } await walk(rootHandle, zip); const a = document.createElement('a'); a.href = URL.createObjectURL(await zip.generateAsync({type:"blob"})); a.download="project.zip"; a.click(); };
</script>
</body>
</html>
